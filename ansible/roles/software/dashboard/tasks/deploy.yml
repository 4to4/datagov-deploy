---
- name: Ensuring php_app_deployment_dir src directory exists
  file:
    path: "{{ php_app_deployment_dir }}/src"
    state: directory

- name: Copying index.php
  template:
    src: "index.php"
    dest: "{{ php_app_deployment_dir }}/src/index.php"

- name: Ensuring config directory exists
  file:
    path: "{{ php_app_deployment_dir }}/src/application/config/{{ web_app_env }}"
    state: directory

- name: Copying config files
  template:
    src: "{{ item }}"
    dest: "{{ php_app_deployment_dir }}/src/application/config/{{ web_app_env }}/{{ item | basename }}"
  with_fileglob:
    - ../templates/config/*.php

- name: Ensuring simplesamlphp/config directory exists
  file:
    path: "{{ php_app_deployment_dir }}/src/vendor/simplesamlphp/simplesamlphp/config"
    state: directory

- name: Copying SAML config files
  template:
    src: "{{ item }}"
    dest: "{{ php_app_deployment_dir }}/src/vendor/simplesamlphp/simplesamlphp/config/{{ item | basename }}"
  with_fileglob:
    - ../templates/saml/config/*.php

- name: Ensuring simplesamlphp/metadata directory exists
  file:
    path: "{{ php_app_deployment_dir }}/src/vendor/simplesamlphp/simplesamlphp/metadata"
    state: directory

- name: Copying SAML metadata files
  template:
    src: "saml/metadata/{{ saml2_idp_entry }}/saml20-idp-remote.php"
    dest: "{{ php_app_deployment_dir }}/src/vendor/simplesamlphp/simplesamlphp/metadata/saml20-idp-remote.php"

- name: Adding .env
  template:
    src: ".env"
    dest: "{{ php_app_deployment_dir }}/src/.env"

- name: Set up campaign status cfo-act download cron job to run @ 11:15pm EST nightly
  cron:
    name: "campaign status cfo-act download cron job"
    minute: 15
    hour: 4
    job: "/usr/bin/php {{ php_app_deployment_dir }}/src/index.php campaign status cfo-act download | tee /var/log/dashboard-cron-cfo.log | mail -s 'LabsData - Dashboard (cfo-act download) - {{ real_ansible_env }} Cron Job' -a 'From: {{ default_email_from }}' {{ cron_to_emails }}"
  when: crons_enabled
  tags:
    - skip_ansible_lint

- name: Set up campaign status cfo-act full-scan cron job to run @ 11:30pm EST nightly
  cron:
    name: "campaign status cfo-act full-scan cron job"
    minute: 30
    hour: 4
    job: "/usr/bin/php {{ php_app_deployment_dir }}/src/index.php campaign status cfo-act full-scan | tee /var/log/dashboard-cron.log | mail -s 'LabsData - Dashboard (cfo-act full-scan) - {{ real_ansible_env }} Cron Job' -a 'From: {{ default_email_from }}' {{ cron_to_emails }}"
  when: crons_enabled
  tags:
    - skip_ansible_lint
